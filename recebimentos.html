<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AtlAS — Recebimentos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Reset primeiro -->
  <link rel="stylesheet" href="css/reset.css">
  
  <!-- Estrutura básica -->
  <link rel="stylesheet" href="css/layout.css">
  
  <!-- Tipografia -->
  <link rel="stylesheet" href="css/typography.css">
  
  <!-- Componentes reutilizáveis -->
  <link rel="stylesheet" href="css/components.css">
  
  <!-- Dashboard -->
  <link rel="stylesheet" href="css/dashboard.css">
  
  <!-- Estilo principal (cores globais, ajustes) -->
  <link rel="stylesheet" href="css/style.css">
  
  <!-- Tema escuro opcional -->
  <link rel="stylesheet" href="css/dark-theme.css">
  
  <!-- Centralizador (se for usado como no protótipo) -->
  <link rel="stylesheet" href="css/main.css">

</head>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <img src="img/logo.png" alt="AtlAS"/>
        <span>AtlAS</span>
      </div>
      <nav id="sidebar-menu"></nav>
      <div class="sidebar-footer">
        <button id="logout-btn" class="btn btn-ghost">Sair</button>
      </div>
    </aside>

    <div class="content">
      <header class="header">
        <button class="burger" id="burger" aria-label="Menu"></button>
        <h1 class="page-title">Recebimentos</h1>
        <div class="spacer"></div>
        <div id="user-chip" class="user-chip"></div>
      </header>

      <main class="main">
        <form class="form card" id="form-recebimento">
          <div class="form-row">
            <div class="form-field">
              <label>Data</label>
              <input type="date" id="data" required/>
            </div>
            <div class="form-field">
              <label>Galpão</label>
              <select id="id_galpao" required></select>
            </div>
            <div class="form-field">
              <label>Projeto</label>
              <select id="id_projeto" required></select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-field">
              <label>Operador</label>
              <input type="text" id="operador" placeholder="Seu nome"/>
            </div>
            <div class="form-field">
              <label>Status</label>
              <input type="text" value="pendente" disabled/>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvar</button>
            <button type="button" id="btn-recarregar" class="btn btn-ghost">Recarregar lista</button>
          </div>
        </form>

        <section class="card">
          <div class="table-head">
            <h3>Recebimentos Cadastrados</h3>
            <div class="filters">
              <input type="text" id="filtro" placeholder="Filtrar por operador/projeto..."/>
            </div>
          </div>
          <div class="table-wrap">
            <table class="table" id="tabela">
              <thead>
                <tr>
                  <th>ID</th><th>Data</th><th>Galpão</th><th>Projeto</th><th>Operador</th><th>Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/data.js"></script>
  <script src="js/main.js"></script>
  <script>
    // Preenche selects com catálogos
    async function carregarCatalogos() {
      const [galp, proj] = await Promise.all([
        apiGet('get_galpoes'),
        apiGet('get_projetos') // se ainda não existir rota, pode comentar
      ]);

      const selGalpao = document.getElementById('id_galpao');
      const selProjeto = document.getElementById('id_projeto');

      (galp?.data ?? []).forEach(g =>
        selGalpao.insertAdjacentHTML('beforeend', `<option value="${g.id_galpao}">${g.nome}</option>`));

      (proj?.data ?? []).forEach(p =>
        selProjeto.insertAdjacentHTML('beforeend', `<option value="${p.id_projeto}">${p.nome}</option>`));
    }

    async function carregarTabela() {
      const resp = await apiGet('get_recebimentos');
      const tbody = document.querySelector('#tabela tbody');
      tbody.innerHTML = '';
      (resp?.data ?? []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id_recebimento}</td>
          <td>${r.data ?? ''}</td>
          <td>${r.id_galpao ?? ''}</td>
          <td>${r.id_projeto ?? ''}</td>
          <td>${r.operador ?? ''}</td>
          <td><span class="badge">${r.status ?? ''}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('form-recebimento').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = document.getElementById('data').value;
      const id_galpao = document.getElementById('id_galpao').value;
      const id_projeto = document.getElementById('id_projeto').value;
      const operador = document.getElementById('operador').value || (JSON.parse(localStorage.getItem('atlas_user'))?.nome ?? '');

      const res = await apiPost('insert_recebimento', { data, id_galpao, id_projeto, operador });
      if (res?.ok) {
        alert('Recebimento criado com sucesso.');
        await carregarTabela();
        (e.target).reset();
      } else {
        alert('Falha ao criar.');
      }
    });

    document.getElementById('btn-recarregar').addEventListener('click', carregarTabela);
    document.getElementById('filtro').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('#tabela tbody tr').forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    (async function init() {
      await requireAuth();
      await carregarCatalogos();
      await carregarTabela();
    })();
  </script>
</body>
</html>
